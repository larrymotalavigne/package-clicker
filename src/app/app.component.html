<!-- Seasonal Banner -->
@if (currentSeason) {
  <app-seasonal-banner [season]="currentSeason"></app-seasonal-banner>
}

<!-- News Ticker -->
<app-news-ticker [context]="newsContext()"></app-news-ticker>

<div id="game-container" role="main">
  <!-- Left Panel -->
  <div id="left-panel">
    <div id="header">
      <h1>Package Clicker</h1>
      <div id="stats" aria-live="polite">
        <div id="package-counter">
          <span id="package-count">{{ formatNumber(gameState().packages) }}</span>
          <span class="label">packages</span>
        </div>
        <div id="pps-display">
          per second: <span id="pps">{{ formatNumber(effectivePps()) }}</span>
        </div>
        @if (gameState().expressPoints > 0) {
          <div class="ep-display">
            <span class="ep-icon">⚡</span>
            <span class="ep-count">{{ formatNumber(gameState().expressPoints) }} EP</span>
          </div>
        }
      </div>
    </div>

    <app-buff-display
      [buffs]="gameState().activeBuffs"
      [events]="activeEvents()"
    ></app-buff-display>

    <div id="main-game-area">
      <div id="package-container" (click)="clickPackage($event)" role="button" aria-label="Click to earn packages" tabindex="0">
        <!-- CSS-only 3D cardboard box -->
        <div id="big-package" [class.clicking]="isClicking">
          <div class="box-3d">
            <div class="box-top"></div>
            <div class="box-front"></div>
            <div class="box-right"></div>
          </div>
        </div>
        @if (streakDisplay()) {
          <div class="streak-counter">{{ streakDisplay() }}</div>
        }
        <app-particle-effects [enabled]="gameState().settings.particleEffects"></app-particle-effects>
        <app-wrinkler
          [wrinklers]="wrinklers()"
          (pop)="popWrinkler($event)"
        ></app-wrinkler>
        <app-golden-package
          [visible]="goldenVisible()"
          [x]="goldenPosition().x"
          [y]="goldenPosition().y"
          (goldenClick)="clickGolden()"
        ></app-golden-package>
      </div>
    </div>

    <app-milk-bar [percentage]="milkPercent()"></app-milk-bar>

    <app-progress-hints
      [hints]="progressHints()"
      [currentIndex]="hintIndex"
    ></app-progress-hints>

    <!-- Bottom bar -->
    <div id="bottom-bar" role="navigation" aria-label="Game actions">
      <button class="bar-btn" (click)="showStats = true" aria-label="Open stats (S)">Stats</button>
      <button class="bar-btn" (click)="showOptions = true" aria-label="Open options (O)">Options</button>
      @if (gameState().prestige.level > 0 || prestigePendingGain() > 0) {
        <button
          class="bar-btn prestige-btn"
          (click)="showPrestige = true"
          aria-label="Open prestige screen"
        >
          Ascend
          @if (prestigePendingGain() > 0) {
            <span class="prestige-badge">
              +{{ prestigePendingGain() }}
            </span>
          }
        </button>
      }
      @if (gameState().completedChallenges.length > 0 || gameState().expressPoints >= 10) {
        <button class="bar-btn challenge-btn" (click)="showChallenges = true" aria-label="Open challenges (C)">
          Challenges
        </button>
      }
      @if (gameState().loreUnlocked.length > 0) {
        <button class="bar-btn lore-btn" (click)="showLore = true" aria-label="Open lore (L)">
          Lore
        </button>
      }
      @if (gameState().expressPoints >= 5) {
        <button class="bar-btn minigame-btn" (click)="showMiniGame = true" aria-label="Play mini-game">
          Mini-Game
        </button>
      }
      @if (totalBuildings() >= 10) {
        <button class="bar-btn contract-btn" (click)="showContracts = true" aria-label="Open contracts (R)">
          Contracts
        </button>
      }
      @if (totalBuildings() >= 25) {
        <button class="bar-btn route-btn" (click)="showRoutePlanner = true" aria-label="Route planner (P)">
          Route Plan
        </button>
      }
    </div>
  </div>

  <!-- Right Panel -->
  <div id="right-panel">
    <div id="store-header">Buildings</div>

    <app-upgrade-panel
      [upgrades]="availableUpgrades()"
      [packages]="gameState().packages"
      (purchase)="purchaseUpgrade($event)"
    ></app-upgrade-panel>

    <div id="store-items">
      @for (building of getBuildingConfigs(); track building.id) {
        <app-building-card
          [building]="building"
          [buildingData]="getBuildingData(building.id)"
          [affordable]="canAfford(building.id)"
          [formattedPrice]="formatNumber(getBuildingPrice(building.id))"
          (buildingClick)="buyBuilding($event)"
        ></app-building-card>
      }
    </div>
  </div>
</div>

<!-- Achievement Popup -->
@if (achievementPopup) {
  <div class="achievement-toast" role="alert">
    {{ achievementPopup }}
  </div>
}

<!-- Loot Drop Toast -->
@if (lastLootDrop(); as loot) {
  <app-loot-display [loot]="loot"></app-loot-display>
}

<!-- Challenge Result -->
@if (challengeResult(); as result) {
  <div class="achievement-toast" [class.challenge-fail]="!result.success" role="alert">
    {{ result.success ? '✅ Challenge Complete!' : '❌ Challenge Failed' }}
    @if (result.reward) {
      <span class="toast-reward">+{{ result.reward }} EP</span>
    }
  </div>
}

<!-- Contract Result -->
@if (contractResult(); as cResult) {
  <div class="achievement-toast" [class.challenge-fail]="!cResult.success" role="alert">
    {{ cResult.success ? '✅ Contract Complete!' : '❌ Contract Expired' }}
    @if (cResult.reward) {
      <span class="toast-reward">+{{ cResult.reward }} EP</span>
    }
  </div>
}

<!-- Screen Flash -->
@if (screenFlashClass) {
  <div class="screen-flash" [class]="screenFlashClass"></div>
}

<!-- Event Popup -->
@if (pendingEvent(); as event) {
  <app-event-popup
    [event]="event"
    (accept)="acceptEvent()"
    (dismiss)="dismissEvent()"
  ></app-event-popup>
}

<!-- Offline Earnings Popup -->
@if (offlineEarnings() > 0) {
  <app-offline-popup
    [earnings]="offlineEarnings()"
    [formattedEarnings]="formatNumber(offlineEarnings())"
    [seconds]="offlineSeconds()"
    (claim)="claimOffline()"
  ></app-offline-popup>
}

<!-- Panels -->
@if (showStats) {
  <app-stats-panel
    [state]="gameState()"
    [perClick]="effectiveClick()"
    [achievementProgress]="achievementProgress()"
    [unlockedCount]="achievementService.unlockedCount()"
    [totalCount]="achievementService.totalCount()"
    [completionPct]="achievementService.completionPercentage()"
    [buildingStats]="buildingStats()"
    [fmt]="formatNumber.bind(this)"
    (closePanel)="showStats = false"
  ></app-stats-panel>
}

@if (showOptions) {
  <app-options-panel
    [settings]="gameState().settings"
    (closePanel)="showOptions = false"
    (save)="handleSave()"
    (exportSave)="handleExport()"
    (importSave)="handleImport($event)"
    (wipeSave)="handleWipe()"
    (settingChange)="handleSettingChange($event)"
  ></app-options-panel>
}

@if (showPrestige) {
  <app-prestige-screen
    [prestige]="gameState().prestige"
    [pendingGain]="prestigePendingGain()"
    [upgrades]="prestigeService.heavenlyUpgrades"
    (closeScreen)="showPrestige = false"
    (ascend)="ascend()"
    (purchaseUpgrade)="purchaseHeavenly($event)"
  ></app-prestige-screen>
}

@if (showChallenges) {
  <app-challenge-panel
    [available]="challengeService.getAvailableChallenges()"
    [active]="activeChallenge()"
    [completedCount]="gameState().completedChallenges.length"
    [totalCount]="challengeService.getAllChallenges().length"
    [result]="challengeResult()"
    (startChallenge)="startChallenge($event)"
    (closePanel)="showChallenges = false"
  ></app-challenge-panel>
}

@if (showLore) {
  <app-lore-viewer
    [entries]="loreService.unlockedLore()"
    [total]="loreService.totalCount"
    (closePanel)="showLore = false"
  ></app-lore-viewer>
}

@if (showMiniGame) {
  <app-mini-game
    (complete)="completeMiniGame($event)"
    (closeGame)="showMiniGame = false"
  ></app-mini-game>
}

@if (showContracts) {
  <app-contract-panel
    [contracts]="contractService.activeContracts()"
    [refreshTimer]="contractService.boardRefreshTimer()"
    [expressPoints]="gameState().expressPoints"
    [completedCount]="contractService.completedContractCount()"
    [fmt]="formatNumber.bind(this)"
    (closePanel)="showContracts = false"
    (acceptContract)="acceptContractSlot($event)"
    (refreshSlot)="refreshContractSlot($event)"
  ></app-contract-panel>
}

@if (showRoutePlanner) {
  <app-route-planner
    (complete)="completeRoutePlanner($event)"
    (closeGame)="showRoutePlanner = false"
  ></app-route-planner>
}

<app-tooltip></app-tooltip>
